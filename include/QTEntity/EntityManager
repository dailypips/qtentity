#pragma once

#include <QTEntity/Export>
#include <QTEntity/EntitySystem>
#include <QMap>
#include <QString>

namespace qte
{

    class QTENTITY_EXPORT EntityManager
    {
    public:

        typedef QMap<QString,EntitySystem*> EntitySystemStore;

        EntityManager();
		~EntityManager();
            

        EntityId createEntity()
        {
            EntityId eid = _entityCounter.fetchAndAddRelaxed(1);
            return eid;
        }

        template <typename T>
        bool getES(T*& es) const;

        void addEntitySystem(EntitySystem* es);

    private:
        EntitySystemStore _systems;
        QAtomicInt _entityCounter;
    };


    template <typename T>
    bool EntityManager::getES(T*& es) const
    {
        QString cn = T::staticMetaObject.className();
        EntitySystemStore::const_iterator i = _systems.constFind(cn);
        if(i == _systems.end())
        {
            es = NULL;
            return false;
        }
        EntitySystem* s = i.value();
        Q_ASSERT(dynamic_cast<T*>(s) != NULL);
        es = static_cast<T*>(s);
        return true;
    }
}
