#pragma once

#include <QTEntity/Export>
#include <QTEntity/EntitySystem>
#include <QMap>
#include <QString>

namespace qte
{

    class QTENTITY_EXPORT EntityManager
    {
    public:

        typedef QMap<const QMetaObject*,EntitySystem*> EntitySystemStore;

        EntityManager();
		~EntityManager();
            

        EntityId createEntity()
        {
            EntityId eid = _entityCounter.fetchAndAddRelaxed(1);
            return eid;
        }

        /*template <typename T>
        bool getES(T*& es) const;*/

        template <typename T>
        bool getComponent(EntityId id, T*& component) const;

        void addEntitySystem(EntitySystem* es);

    private:
        EntitySystemStore _systems;
        QAtomicInt _entityCounter;
    };


    /*template <typename T>
    bool EntityManager::getES(T*& es) const
    {
        QString cn = T::staticMetaObject.className();
        EntitySystemStore::const_iterator i = _systems.constFind(cn);
        if(i == _systems.end())
        {
            es = NULL;
            return false;
        }
        EntitySystem* s = i.value();
        Q_ASSERT(dynamic_cast<T*>(s) != NULL);
        es = static_cast<T*>(s);
        return true;
    }*/

    template <typename T>
    bool EntityManager::getComponent(EntityId id, T*& component) const
    {
        const QMetaObject* mo = &T::staticMetaObject;
        EntitySystemStore::const_iterator i = _systems.constFind(mo);
        if(i == _systems.end())
        {
            component = NULL;
            return false;
        }
        EntitySystem* s = i.value();
        Component* c = s->getComponent(id);
        if(c == NULL)
        {
            component = NULL;
            return false;
        }
        component = qobject_cast<T*>(c);
        return true;
    }
}
